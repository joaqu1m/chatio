<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="./assets/js/utilities.js"></script>
    <link rel="stylesheet" href="./assets/css/styles.css">
    <title>chatTesting</title>
</head>
<body>
    <div class="chat">
        <div id="caixote"></div>
        <div id="areaInput">
            <input type="text" id="telaChatTexto" placeholder="Digite sua mensagem aqui..." maxlength="512">
            <div><img src="./assets/imgs/715vwvP5ZEL.png" height="100%"></div>
            <div onclick="mandarMensagem()"><img src="./assets/imgs/send-message-2-2.png" height="100%"></div>
        </div>
    </div>
    <div id="telaChat" class="menu">
        <div id="botoes">
            <button onclick="mudarNome(true)" id="telaChatBotaoMudarNome">mudar nome</button>
        </div>
    </div>
    <div id="telaMudarNome" class="menu" style="display: none;">
        <div>
            <input type="text" placeholder="novo nome" id="telaMudarNomeNewName" maxlength="16">
        </div>
    </div>
</body>
</html>
<script>
    var ultimoIdProcurado = 0
    var nomeAtual = ""

    if (localStorage.nome != undefined) {
        telaMudarNomeNewName.value = localStorage.nome
    } else {
        telaChatBotaoMudarNome.innerHTML = "criar nome"
    }

    telaChatTexto.addEventListener("keydown", function(resposta) {
        if (resposta.key == "Enter") {
            resposta.preventDefault()
            mandarMensagem()
        }
    })

    telaMudarNomeNewName.addEventListener("keydown", function(resposta) {
        if (resposta.key == "Enter") {
            resposta.preventDefault()
            mudarNome(false)
        }
    })

    //Funções do banco

    fetch("/chat/buscarUltimoId", {
        method: "GET"
    })
    .then(function (response) {
        if (response.ok) {
            response.json().then(function (resposta) {
                ultimoIdProcurado = resposta[0].id
                setInterval(buscarNovasMensagens, 500)
                setInterval(deletarMensagensAntigas, 30000)
            })
        }
    })

    function buscarNovasMensagens() {
        fetch(`/chat/buscarNovasMensagens/${ultimoIdProcurado}`, {
            method: "GET"
        })
        .then(function (response) {
            if (response.ok && response.statusText != "No Content") {
                response.json().then(function (resposta) {
                    resposta = resposta.reverse()
                    ultimoIdProcurado = resposta[resposta.length-1].idMensagem
                    for (i = 0; i < resposta.length; i ++) {
                        if (resposta[i].dono == nomeAtual) {
                            caixote.innerHTML += `<div class="mensagem">${resposta[i].texto}</div>`
                        } else {
                            caixote.innerHTML += `<div class="mensagem"><b style="font-size: 75%;">${resposta[i].dono} diz:</b><br>${resposta[i].texto}</div>`
                        }
                        nomeAtual = resposta[i].dono
                        caixote.scrollTop = caixote.scrollHeight
                    }
                })
            }
        })
    }

    function deletarMensagensAntigas() {
        fetch(`/chat/deletarMensagensAntigas/${ultimoIdProcurado}`, {
            method: "GET"
        })
        .then(function (response) {
            if (response.ok && response.statusText != "No Content") {
                response.json().then(function (resposta) {
                    console.log(resposta)
                })
            }
        })
    }

    function mudarNome(solicitando) {
        if (solicitando) {
            telaChat.style.display = 'none'
            telaMudarNome.style.display = 'flex'
        } else {
            if (telaMudarNomeNewName.value == '') {
                alert('coloca um nome rapaz')
                return
            }

            localStorage.nome = trocarCaractere(trocarCaractere(trocarCaractere(telaMudarNomeNewName.value, "  ", ""), "<", ""), ">", "").trim()
            telaChatBotaoMudarNome.innerHTML = "mudar nome"
            telaMudarNome.style.display = 'none'
            telaChat.style.display = 'flex'
        }
    }

    function mandarMensagem() {
        if (localStorage.nome == undefined) {
            alert('defina um nome de perfil e tente novamente')
            mudarNome(true)
            return
        }
        if (telaChatTexto.value == "") {
            alert('manda algo vacilão')
            return
        }

        fetch("/chat/mandarMensagem", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                nome: localStorage.nome,
                texto: trocarCaractere(trocarCaractere(trocarCaractere(telaChatTexto.value, "  ", " "), "<", ""), ">", "").trim()
            })
        })
        .then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    telaChatTexto.value = ""
                    if (resposta != null) {
                        console.log("Mensagem enviada com sucesso")
                    }
                })
            }
        })
    }
</script>