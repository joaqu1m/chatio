<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3d test</title>
    <style>
        body {
            margin: 0;
        }

        .grade {
            display: flex;
        }

        #visualizacao {
            width: 75vh;
            height: 75vh;
            background-color: grey;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid black;
            overflow: hidden;
        }

        #visPelicula {
            width: 500px;
            height: 500px;
            position: absolute;
            z-index: 1;
            cursor: move;
        }

        #visGrupos {
            width: 150px;
            height: 150px;
            transform-style: preserve-3d;
        }

        .grupo {
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            position: absolute;
        }

        .face {
            position: absolute;
            /*
            backface-visibility: hidden;
            */
        }

        #informacoes {
            width: 75vh;
            height: calc(25vh - 4px);
            border: 1px solid black;
            display: flex;
            flex-direction: column;
        }

        #infTitulo {
            width: 100%;
            height: 25%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #infBoxes {
            width: 100%;
            height: 75%;
            display: flex;
        }

        .infMetricas {
            width: 33.3%;
            height: 100%;
            border-left: 1px solid black;
            border-top: 1px solid black;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .grdCaixaHorizontal {
            width: calc(100vw - 75vh - 4px);
            height: calc(25vh - 4px);
            border: 1px solid black;
        }

        #meshesLista {
            margin-top: calc(50vh + 2px);
        }
        .selOff {
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="grade">
        <div>
            <div id="visualizacao">
                <div id="visPelicula" class="selOff">
                    <button class="selOff" onclick="redefinirCamera()">Redefinir câmera</button>
                    <button class="selOff" onclick="zoomCamera(true)">Zoom+</button>
                    <button class="selOff" onclick="zoomCamera(false)">Zoom-</button>
                </div>
                <div id="visGrupos">
                    <div id="grupo1" class="grupo"></div>
                    <div id="grupo2" class="grupo"></div>
                </div>
            </div>
            <div id="informacoes">
                <div id="infTitulo"></div>
                <div id="infBoxes"></div>
            </div>
        </div>
        <div>
            <div id="cameraLista" class="grdCaixaHorizontal"><button onclick="teste()">mover grupo 1</button></div>
            <div id="meshesLista" class="grdCaixaHorizontal"></div>
        </div>
    </div>
</body>
</html>
<script type="text/javascript" src="./assets/js/utilities.js"></script>
<script>
    let meshConfigs = {
        grupos: [],
        meshes: [],
        meshSelecionada: ""
    }

    meshConfigs.grupos.push({
        id: 1,
        rX: 0,
        rY: 0,
        rZ: 0,
        tX: 0,
        tY: 0,
        tZ: 0
    })

    meshConfigs.meshes.push({
        id: 1,
        width: "100%",
        height: "100%",
        rX: 0,
        rY: 90,
        rZ: 0,
        tX: 0,
        tY: 0,
        tZ: 50,
        cor: "green",
        grupoFk: 1,
        tipo: "Face"
    })
    meshConfigs.meshes.push({
        id: 2,
        width: "100%",
        height: "125%",
        rX: 0,
        rY: 180,
        rZ: 0,
        tX: 0,
        tY: 0,
        tZ: 50,
        cor: "pink",
        grupoFk: 1,
        tipo: "Face"
    })
    meshConfigs.meshes.push({
        id: 3,
        width: "100%",
        height: "125%",
        rX: 0,
        rY: 270,
        rZ: 0,
        tX: 0,
        tY: 0,
        tZ: 50,
        cor: "blue",
        grupoFk: 2,
        tipo: "Face"
    })

    function teste() {
        meshConfigs.grupos.rY += 15
        recarregarMedidas()
    }

    recarregarMedidas()

    function recarregarMedidas() {
        for (i = 0; i < meshConfigs.grupos.length; i++) {
            window[`grupo${meshConfigs.grupos[i].id}`].innerHTML = ""
        }
        for (i = 0; i < meshConfigs.meshes.length; i++) {
            window[`grupo${meshConfigs.meshes[i].grupoFk}`].innerHTML += `<div id="face${meshConfigs.meshes[i].id}" class="face"></div>`
        }
        carregarMedidasGrupos()
        carregarMedidasMeshes()
    }

    function carregarMedidasMeshes() {
        for (i = 0; i < meshConfigs.meshes.length; i++) {
            definirMedidasPoligono(meshConfigs.meshes[i])
        }
    }

    function carregarMedidasGrupos() {
        for (i = 0; i < meshConfigs.grupos.length; i++) {
            definirMedidasPoligono(meshConfigs.grupos[i])
        }
    }

    function definirMedidasPoligono(m) {
        console.log("a")
        let mesh = window[`face${m.id}`].style
        mesh.width = m.width
        mesh.height = m.height
        mesh.transform = `rotateX(${m.rX}deg) rotateY(${m.rY}deg) rotateZ(${m.rZ}deg) translate3d(${porcentagem(m.tX)}px, ${porcentagem(m.tY)}px, ${porcentagem(m.tZ)}px)`
        mesh.backgroundColor = m.cor
    }

    function definirMedidasGrupos(g) {
        window[`grupo${g.id}`].style.transform = `rotateX(${g.rX}deg) rotateY(${g.rY}deg) rotateZ(${g.rZ}deg) translate3d(${porcentagem(g.tX)}px, ${porcentagem(g.tY)}px, ${porcentagem(g.tZ)}px)`
    }

    function atualizarInfo(m) {
        infTitulo.innerHTML = `${m.tipo} ${m.id}`
        infBoxes.innerHTML = `
            <div class="infMetricas">
                <b style="margin-bottom: 2vh;">Rotação</b>
                <span>X: ${m.rX}°</span>
                <span>Y: ${m.rY}°</span>
                <span>Z: ${m.rZ}°</span>
            </div>
            <div class="infMetricas">
                <b style="margin-bottom: 2vh;">Translação</b>
                <span>X: ${m.tX}%</span>
                <span>Y: ${m.tY}%</span>
                <span>Z: ${m.tZ}%</span>
            </div>
            <div class="infMetricas">
                <b style="margin-bottom: 2vh;">Medidas</b>
                <span>W: ${m.width}</span>
                <span>H: ${m.height}</span>
                <span>D: 0</span>
            </div>
        `
    }

    atualizarInfo(meshConfigs.meshes[0])
    /*
    ======
    CÂMERA
    ======
    */

    // Variáveis utilizadas pelas funções da câmera

    let cameraConfigs = {
        eventoEmUso: false,
        cameraPos: {x: 0, y: 0},
        posicaoAnterior: {x: 0, y: 0}
    }

    // Funções utilizadas no back, não são diretamente iniciadas pelo usuário

    function redefinirCamera() {
        cameraConfigs.cameraPos = {x: 0, y: 0}
        definirCamera()
        visGrupos.style.width = "150px"
        visGrupos.style.height = "150px"
        recarregarMedidas()
    }

    function definirCamera() {
        visGrupos.style.transform = `rotateX(${cameraConfigs.cameraPos.x}deg) rotateY(${cameraConfigs.cameraPos.y}deg)`
    }

    function mouseMovendo(e) {
        pegarPrimeirasCoords(e)
        let rect = e.target.getBoundingClientRect()
        let mouseX = e.clientX - rect.left
        let mouseY = e.clientY - rect.top

        cameraConfigs.cameraPos.x -= mouseY - cameraConfigs.posicaoAnterior.y
        cameraConfigs.cameraPos.y += mouseX - cameraConfigs.posicaoAnterior.x

        definirCamera()

        cameraConfigs.posicaoAnterior = {x: mouseX, y: mouseY}

    }

    function pegarPrimeirasCoords(e) {
        let rect = e.target.getBoundingClientRect()
        let mouseX = e.clientX - rect.left
        let mouseY = e.clientY - rect.top
        cameraConfigs.posicaoAnterior = {x: mouseX, y: mouseY}
        pegarPrimeirasCoords = function(e) {}
    }

    function redefinirPegarPrimeirasCoords() {
        pegarPrimeirasCoords = function(e) {
            let rect = e.target.getBoundingClientRect()
            let mouseX = e.clientX - rect.left
            let mouseY = e.clientY - rect.top
            cameraConfigs.posicaoAnterior = {x: mouseX, y: mouseY}
            pegarPrimeirasCoords = function(e) {}
        }
    }

    // Funções ativadas pelo usuário

    visPelicula.onpointerdown = function() {
        cameraConfigs.eventoEmUso = true
        visPelicula.addEventListener("mousemove", mouseMovendo)
    }
    visPelicula.onmouseout = function() {
        visPelicula.removeEventListener("mousemove", mouseMovendo)
        cameraConfigs.eventoEmUso = false
        redefinirPegarPrimeirasCoords()
    }
    visPelicula.oncontextmenu = function() {
        visPelicula.removeEventListener("mousemove", mouseMovendo)
        cameraConfigs.eventoEmUso = false
        redefinirPegarPrimeirasCoords()
    }
    visPelicula.onpointerup = function() {
        visPelicula.removeEventListener("mousemove", mouseMovendo)
        cameraConfigs.eventoEmUso = false
        redefinirPegarPrimeirasCoords()
    }
    visPelicula.ondragstart = () => {
        return false
    }

    function zoomCamera(mais) {
        if (mais) {
            if (visGrupos.offsetWidth + 25 > 250) {
                return
            }
            visGrupos.style.width = `${visGrupos.offsetWidth + 25}px`
            visGrupos.style.height = `${visGrupos.offsetHeight + 25}px`
        } else {
            if (visGrupos.offsetWidth <= 25) {
                return
            }
            visGrupos.style.width = `${visGrupos.offsetWidth - 25}px`
            visGrupos.style.height = `${visGrupos.offsetHeight - 25}px`
        }
        recarregarMedidas()
    }

    // Definindo a câmera pela primeira vez

    redefinirCamera()
</script>